<calculator>
  <main class="calculator-container">
    <div class="column-left">
      <form class="inputform" onsubmit={ calculateTotals }>
        <label for="principle">Initial deposit</label>
        <input id="principle" ref="principle" type="number" onkeyup={ calculateTotals } value={ principle } placeholder="Principle amount">

        <label for="interest_rate">Interest rate (%)</label>
        <input id="interest_rate" ref="interest_rate" type="number" onkeyup={ calculateTotals } value={ interest_rate } placeholder="Interest rate (%)">

        <label for="years">Time Span: { years } years</label>
        <input id="years" ref="years" type="range" min="1" max="50" oninput={ calculateTotals } value={ years }>

        <input type="submit" value="Calculate" ref="submitbutton">
      </form>

      <div class="totals-table-container">
        <h1>Results</h1>

        <p>
          Total: { overall_total }<br/>
          Interest: { formatValue(overall_total - this.refs.principle.value) }
        </p>

        <h2>Breakdown per year</h2>

        <table class="results">
          <thead>
            <th>#</th>
            <th>Year</th>
            <th>Total</th>
            <th>Interest</th>
          </thead>
          <tr each={ total, i in totals } class="results-row">
            <td class="results-col">{ i+1 }</td>
            <td class="results-col">{ total[OVERALL_TOTAL].year }</td>
            <td class="results-col">{ total[OVERALL_TOTAL].value }</td>
            <td class="results-col">{ formatValue(total[INTEREST].value) }</td>
          </tr>
        </table>
      </div>
    </div>

    <div class="column-right">
      <div class="chart-container">
        <canvas id="chart" width="200" height="100"></canvas>
      </div>
    </div>
  </main>

  <script>
    PRINCIPLE = 'PRINCIPLE'
    INTEREST = 'INTEREST'
    INTEREST_TOTAL = 'INTEREST_TOTAL'
    OVERALL_TOTAL = 'OVERALL_TOTAL'

    // Copy over opts/props passed in constructor. Inits the form with provided values
    Array('years', 'principle', 'interest_rate').forEach(option => this[option] = opts[option])

    this.startYear = new Date().getFullYear() + 1

    this.on('mount', () => {
      this.calculateTotals()
      this.update() // Necessary in mount handler to ensure results table gets rendered
    })

   /**
    * (Re-)render the chart when inputs have changed
    */
   this.on('updated', () => this.renderChart())

    /**
     * Calculate the totals
     * @return {Void}
     */
    calculateTotals (e) {
      if (e instanceof Event) e.preventDefault() // Prevent submitting form

      let previousYear = null
      this.totals = Array.from({length: this.refs.years.value}, (_,i) => {
        let year = this.startYear + i
        let total = this.calculateForYearNumber(i + 1)
        let principle = this.refs.principle.value
        let interest_total = total - principle

        let interest = interest_total
        if (previousYear) interest = interest_total - previousYear[INTEREST_TOTAL].value

        const data = {
          [PRINCIPLE]: { year, value: this.formatValue(principle) },
          [INTEREST]: { year, value: this.formatValue(interest) },
          [INTEREST_TOTAL]: { year, value: this.formatValue(interest_total) },
          [OVERALL_TOTAL]: { year, value: this.formatValue(total) },
        }

        previousYear = data

        return data
      })

      this.overall_total = this.totals[this.totals.length -1][OVERALL_TOTAL].value
      this.years = this.refs.years.value
    }

    /**
     * Calculate the total amount for the requested yearNumber
     * Formula: P' = P(1 + r/n)^nt
     * @see https://en.wikipedia.org/wiki/Compound_interest#Mathematics_of_interest_rate_on_loans
     *
     * @return {Number}
     */
     calculateForYearNumber (yearNumber) {
      let interest = this.refs.interest_rate.value / 100 // decimal
      let compoundingFreqency = 1 // @TODO support additional regular deposits

      return this.refs.principle.value * Math.pow(1 + interest/compoundingFreqency, yearNumber * compoundingFreqency)
    }

    /**
     * Round a number to a given number of decimals
     * @TODO support multiple number formats (thousands separator, decimal separator)
     *
     * @return {Number}
     */
    formatValue (value, decimals = 2) {
      return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals)
    }

    /**
     * Initialize the chart.js object
     * @see http://www.chartjs.org/docs/latest/
     * @return {Void}
     */
    initChart () {
      this.chart = new Chart(document.getElementById('chart'), {
        type: 'bar',
        data: {
          datasets: [
            { label: 'Total principle', backgroundColor: 'orange' },
            { label: 'Total interest', backgroundColor: 'red' },
          ],
        },
        options: {
          scales: {
            xAxes: [{
              stacked: true,
            }],
            yAxes: [{
              stacked: true,
              ticks: {
                beginAtZero:true
              }
            }]
          },
          tooltips: {
            callbacks: {
              title: (tooltipItem, chart) => {
                let total = this.totals[tooltipItem[0].index][OVERALL_TOTAL].value

                return `${tooltipItem[0].xLabel} (total: ${total})`
              },
            }
          },
        }
      })
    }

    /**
     * (Re-)render the chart.js chart
     * By pushing the data points onto the datasets, the chart animates nicely
     *
     * @return {Void}
     */
    renderChart () {
      if (!this.chart) this.initChart()
      this.clearChart()

      if (!this.totals) this.calculateTotals()

      this.totals.forEach(total => {
        this.chart.data.labels.push(total[PRINCIPLE].year)
        this.chart.data.datasets[0].data.push(total[PRINCIPLE].value)
        this.chart.data.datasets[1].data.push(total[INTEREST_TOTAL].value)
      })

      this.chart.update()
    }

    /**
     * Clear the chart.js chart
     * Necessary to ensure the chart animates correctly when new data is added to it
     *
     * @return {Void}
     */
    clearChart () {
      this.chart.data.labels = []
      this.chart.data.datasets.forEach((_, i) => (this.chart.data.datasets[i].data = []))
    }
  </script>

  <style>
    .calculator-container {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      width: 70vw;
      height: 100%;
      margin: auto;
    }
    .column-left {
      display: flex;
      flex-direction: column;
      flex-basis: 30%;
      height: 100%;
    }

    .inputform label {
      font-weight: bold;
    }

    .inputform label + input {
      display: block;
      margin-bottom: 1em;
    }

    .totals-table-container {
      overflow: auto;
    }
    .results {
      border-collapse: separate;
      border-spacing: 0px;
      line-height: 1.5em;
    }

    .results .results-col {
      border: 1px solid black;
      padding: 0 1em;
    }

    .column-right {
      flex-basis: 60%;
      margin: auto;
    }
  </style>
</calculator>
