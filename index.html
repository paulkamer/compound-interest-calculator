<html>
  <head>
  </head>
  <body>
    <calculator />

    <script type="riot/tag">
      DS_PRINCIPLE = 0
      DS_INTEREST = 1
      DS_OVERALL_TOTAL = 2

      <calculator>
        <form onsubmit={ updateTotals }>
          <label for="principle">Initial deposit</label>
          <input id="principle" ref="principle" type="number" onkeyup={ updateTotals } placeholder="Principle amount">

          <label for="interest_rate">Interest rate (%)</label>
          <input id="interest_rate" ref="interest_rate" type="number" onkeyup={ updateTotals } placeholder="Interest rate (%)">

          <label for="years">Years</label>
          <input id="years" ref="years" type="number" onkeyup={ updateTotals } placeholder="Number of years to grow">

          <button>Calculate</button>
        </form>

        <div if={ totals }>
          <h3>Result</h3>
          <p>Total: { totals[totals.length -1][DS_OVERALL_TOTAL].value }</p>

          <table>
            <tr each={ total, i in totals }>
              <td>{ total[DS_OVERALL_TOTAL].year }</td><td>{ total[DS_OVERALL_TOTAL].value }</td>
            </tr>
          </table>

          <div class="chart-container" style="width: 500px">
            <canvas id="chart" width="200" height="100"></canvas>
          </div>
        </div>

        /**
         * Initialize refs when component is mounted
         */
         this.on('mount', function() {
           this.refs.principle.value = 1000
           this.refs.interest_rate.value = 5
           this.refs.years.value = 5

           this.startYear = new Date().getFullYear()
           this.totals = []
           this.chart = null
         })

         /**
          * Render the chart as soon as the totals are available/updated
          * @return {Void
          */
         this.on('updated', function() {
           if (!this.totals || this.totals.length === 0) return

           if (!this.chart) this.initChart()
           this.renderChart()
         })

        /**
         * Calculate the totals
         * @return {Void}
         */
        updateTotals (e) {
          if (e instanceof Event) e.preventDefault() // Prevent submitting form

          this.totals = Array.from({length: this.refs.years.value}, (_,i) => {
            let year = this.startYear + i
            let total = this.calculate(i + 1)
            let principle = this.refs.principle.value

            return [
              { year, value: this.formatValue(principle) },
              { year, value: this.formatValue(total - principle) },
              { year, value: this.formatValue(total) },
            ]
          })
        }

        /**
         * Calculate the total amount for the requested number of years
         * Formula: P' = P(1 + r/n)^nt
         * @see https://en.wikipedia.org/wiki/Compound_interest#Mathematics_of_interest_rate_on_loans
         *
         * @return {Number}
         */
        calculate(years) {
          let interest = this.refs.interest_rate.value / 100 // decimal
          let compoundingFreqency = 1 // @TODO support additional regular deposits

          return this.refs.principle.value * Math.pow(1 + interest/compoundingFreqency, years * compoundingFreqency)
        }

        /**
         * Round a number to a given number of decimals
         * @TODO support multiple number formats (thousands separator, decimal separator)
         *
         * @return {Number}
         */
        formatValue (value, decimals = 2) {
          return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals)
        }

        /**
         * Initialize the chart.js object
         * @see http://www.chartjs.org/docs/latest/
         * @return {Void}
         */
        initChart () {
          this.chart = new Chart(document.getElementById('chart'), {
            type: 'bar',
            data: {
              datasets: [
                { label: 'Total principle', backgroundColor: 'orange' },
                { label: 'Total interest', backgroundColor: 'red' },
              ],
            },
            options: {
              scales: {
                xAxes: [{
                  stacked: true,
                }],
                yAxes: [{
                  stacked: true,
                  ticks: {
                    beginAtZero:true
                  }
                }]
              },
              tooltips: {
                callbacks: {
                  title: (tooltipItem, chart) => {
                    let total = this.totals[tooltipItem[0].index][DS_OVERALL_TOTAL].value

                    return `${tooltipItem[0].xLabel} (total: ${total})`
                  },
                }
              },
            }
          })
        }

        /**
         * (Re-)render the chart.js chart
         * By pushing the data points onto the datasets, the chart animates nicely
         *
         * @return {Void}
         */
        renderChart () {
          this.clearChart()

          this.totals.forEach(total => {
            this.chart.data.labels.push(total[DS_PRINCIPLE].year)
            this.chart.data.datasets[DS_PRINCIPLE].data.push(total[DS_PRINCIPLE].value)
            this.chart.data.datasets[DS_INTEREST].data.push(total[DS_INTEREST].value)
          })

          this.chart.update()
        }

        /**
         * Clear the chart.js chart
         * Necessary to ensure the chart animates correctly when new data is added to it
         *
         * @return {Void}
         */
        clearChart () {
          this.chart.data.labels = []
          this.chart.data.datasets[DS_PRINCIPLE].data = []
          this.chart.data.datasets[DS_INTEREST].data = []
        }
      </calculator>
    </script>

    <script src="https://cdn.jsdelivr.net/npm/riot@3.8/riot+compiler.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js" integrity="sha256-c0m8xzX5oOBawsnLVpHnU2ieISOvxi584aNElFl2W6M=" crossorigin="anonymous"></script>

    <script>riot.mount('calculator')</script>
  </body>
</html>
